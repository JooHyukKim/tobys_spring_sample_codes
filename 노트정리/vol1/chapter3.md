# 3장 템플릿

### 예외 처리

- 일반적으로 서버에서는 제한된 갯수의 DB 커넥션을 만들어서 재사용 가능한 풀로 관리한다.
- DB 풀은 매번 getConnection()으로 가져간 커넥션을 명시적으로 close()해서 돌려줘야 한다.
    - 그리고 다시 풀에 넣어다가 다음 커넥션 요청이 있을 때 재사용할 수 있다.
- 그런데 이런 식으로 오류가 날 때마다 미처 반환되지 못한 Connection이 계속 쌓이면 어느 순간에 커넥션 풀에 여유가 없어지고 리소스가 모자란다는 심각한 오류를 내며 서버가 중단될 수 있다.

### 전략패턴의 적용

- OCP 를 잘 지키는 구조이면서도 템플릿 메소드 패턴보다 유연하고 확장성이 뛰어난 것이 전략 패턴이다.
- 오브젝트를 아예 둘로 분리하고 클래스 레벨에서는 인터페이스를 통해서만 의존하도록 만드는 전략 패턴이다.
- 전략 패턴은 OCP 관점에서 보면 확장에 해당하는 변하는 부분을 별도의 클래스로 만들어 추상화된 인터페이스를 통해 위임하는 방식이다.
- contextMethod()(예를들어) 에서 일정한 구조를 가지고 동작하다가 특별 확장 기능은 Strategy(예를들어) 인터페이스를 통해 외부의 독립된 전략 클래스에 위임하는 것이다.
- dao의 deleteAll() 메소드에서 변하지 않는 부분이라고 명시한 것 (connection close, resultSet close, preparestatement close) 부분이 바로
  contextMethod() 가 된다.
- 예를들어 jdbcTemplate을 직접 구현하는 contextMethod()에서 작업 진행순서는 다음과 같다.
    - DB 커넥션 가져오기
    - preparedStatement 를 만들어줄 외부기능 호출하기
    - ps 실행하기
    - 예외 발생시 이를 다시 메소드 밖으로 던지기
    - 모든 경우에 만들어진 preparedstatement, 커넥션 등을 적절히 닫아주기

> DI를 위해서는 주입되는 오브젝트와 주입받는 오브젝트 양쪽 모두 스프링 빈으로 등록돼야 한다.

- 스프링이 생성하고 관리하는 IoC 대상이어야 DI에 참어햘 수 있기 때문이다.
- 따라서 JdbcContext 는 다른 빈을 DI 받기 위해서라도 스프링 빈으로 등록돼야한다.
- 실제로 스프링에는 드물지만 이렇게 인터페이스를 사용하지 않는 클래스를 직접 의존하는 DI 가 등장하는 경우도 있다.
- 여기서 중요한 것은 인터페이스의 사용 여부다.
- 굳이 인터페이스를 두지 않아도 될 만큼 긴밀한 관계를 갖는 DAO 클래스와 JdbcContext를 어색하게 따로 빈으로 분리하지 않고 내부에서 직접 만들어 사용하면서도 다른 오브젝트에 대한 DI를 적용시키는 좋은
  옵션도 있다.

-----

## 템플릿과 콜백

### 전략 패턴의 적용

- getConnection() -> executeUpdate() 과같이 복잡하지만 바뀌지않는 일정한 패턴을 갖는 작업 흐름이 존재하고 그중 일부분만 자주 바꿔서 사용해야 하는 경우에 적합하다.
- 전략 패턴의 기본 구조에 익명 내부 클래스를 활용한 방식이다.
- 이런 방식을 스프링에서는 템플릿/콜백 패턴이라고 부른다.
- 전략 패턴의 컨텍스트를 템플릿이라고 부르고
- 익명 내부 클래스로 만들어지는 오브젝트를 콜백이라고 부른다.
    - 자바에서는 메소드 자체를 파라미터로 전달할 방법이 없기 때문에 메소드가 담긴 오브젝트를 전달해야하며 그래서 펑셔널 오브젝트라고도 한다.

### 템플릿/콜백의 특징


- 여러 개의 메소드를 가진 일반적인 인터페이스를 사용할 수 있는 전략 패턴의 전략과 달리 템플릿/콜백 패턴의 콜백은 보통 단일 메소드 인터페이스를 사용한다.
- 팀플릿의 작업 흐름중 한 번 호출되는 경우가 일반적이기 때문이다.
    - 콜백 메소드에는 보통 컨텍스트 정보를 전달 받는 파라미터가 있다.
- 클라이어트의 역할은 템플릿 안에서 실행될 로직을 담은 오브젝트를 만들고, 콜백이 참조할 정보를 제공하는 것이다.
    - 만들어진 콜백은 클라이언트가 템플릿의 메소드를 호출할 때 파라미터로 전달된다.
- 템플릿은 정해진 작업 흐름을 따라 작업을 진행하다가 내부에서 생성한 참조정보를 가지고 콜백 오브젝트의 메소드를 호출한다. 콜백은 클라이언트 메소드에 있는 정보와 템플릿이 제공한 참조정보를 이용해서 작업을 수행하고
  그 결과를 다시 템플릿에 돌려준다.
- 템플릿은 콜백이 돌려준 정보를 사용해서 작업을 마저 수행한다. 경우에 따라 최종결과를 클라이언트에 다시 돌려주기도 한다.

### 3.7. 정리

- 3장에서는 예외처리와 안젛난 리소스 반환을 보장해주는 DAO 코드를 만들고 이를 객체지향 설계 원리와 디자인 패턴, DI 등을 적용해서 깔끔하고 유연하며 단순한 코드로 만드는 방법을 살펴봤다. 3장에서 다룬
  내용은 다음과 같다.
- JDB와 같은 예외가 발생할 가능성이 있으며 공유 리소스의 반환이 필요한 코드는 반드시 try/catch/finally 블록으로 관리해야한다.
- 일정한 작업 흐름이 반복되면서 일부 기능만 바뀌는 코드가 존재한다면 전략 패턴을 적용한다.
    - 바뀌지 않는 부분은 컨텍스트로,
    - 바뀌는 부분은 전략으로 만들고
    - 인터페이스를 통해 유연하게 전략을 변경할 수 있도록 구성한다.
- 같은 애플리케이션 안에서 여러 가지 종류의 전략을 다이내믹하게 구성하고 사용해야 한다면 컨텍스트를 이용하는 클라이언트 메소드에서 직접 전략을 정의하고 제공하게 만든다.
- 클라이언트 메소드 안에 익명 내부 클래스를 사용해서 전략 오브젝트를 구현하면 코드도 간결해지고 메소드의 정보를 직접 사용할 수 있어서 편리하다.
- 컨텍스트가 하나 이상의 클라이언트 오브젝트에서 사용된다면 클래스를 분리해서 공유하도록 만든다.
- 컨텍스트는 별도의 빈으로 등록해서 DI 받거나 클라이언트 클래스에서 직접 생성해서 사용하낟.
    - 클래스 내부에서 컨텍스트를 사용할 때 컨텍스트가 의존하는 외부의 오브젝트가 있다면 코드를 이용해서 직접 DI 해줄 수 있다.
- 단일 전략 메소드를 갖는 전략 패턴이면서 익명 내부 클래스를 사용해서 매번 전략을 새로 만들어 사용하고, 컨텍스트 호출과 동시에 전략 DI를 수행하는 방식을 템플릿/콜백 패턴이라고 한다.
- 콜백의 코드에도 일정한 패턴이 반복된다면 콜백을 템플릿에 넣고 재활용하는 것이 편리하다.
- 템플릿과 콜백의 타입이 다양하게 바뀔 수 있다면 제네릭스를 이용한다.
- 스프링은 JDBC 코드 작성을 위해 JdbcTemplate 을 기반으로 하는 다양한 템플릿과 콜백을 제공한다.
- 템플릿은 한 번에 하나 이상의 콜백을 사용할 수도 있고, 하나의 콜백을 여러 번 호출할 수도 있다.
- 템플릿 콜백을 설계할 대는 템플릿과 콜백 사이에 주고받는 정보에 관심을 둬야한다.
- 템플릿/콜백은 스프링이 객체지향 설계와 프로그래밍에 얼마나 가치를 두고 있는지 잘 보여주는예다.
    - 스프링이 제공하는 템플릿/콜백을 사용하는것은 물론이며 직접 템플릿/콜백을 만들어 활용할 수도 있어야한다.












